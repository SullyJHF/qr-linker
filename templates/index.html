<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>{{.Title}}</h1>
        {{if .Username}}
        <div class="user-info">
          <span>Logged in as: <strong>{{.Username}}</strong></span>
          <a href="/logout" class="btn-logout">Logout</a>
        </div>
        {{end}}
      </header>

      <main>
        <div class="url-shortener-card">
          <h2>Shorten Your URL</h2>
          <p>Enter a URL below to create a short link</p>

          <form id="url-form" action="/shorten" method="POST">
            <div class="form-group">
              <input
                type="text"
                name="url"
                id="url-input"
                placeholder="example.com/your-long-url"
                required
                class="url-input"
              />
              <button type="submit" class="btn-primary">Shorten URL</button>
            </div>
          </form>

          {{if .ShortURL}}
          <div class="result-card" id="successCard">
            <button class="close-success" onclick="closeSuccess()" title="Close">&times;</button>
            <h3>Success! Your short URL is:</h3>
            <div class="short-url-display">
              <a href="{{.ShortURL}}" target="_blank">{{.Host}}{{.ShortURL}}</a>
              <button
                onclick="copyToClipboard('{{.Host}}{{.ShortURL}}', this)"
                class="btn-copy"
              >
                Copy
              </button>
            </div>
            <div class="qr-code-section">
              <h4>QR Code:</h4>
              <img
                src="/qr{{.ShortURL}}"
                alt="QR Code for {{.Host}}{{.ShortURL}}"
                class="qr-code-image"
              />
              <p class="qr-code-help">
                Scan with your phone to access the link
              </p>
            </div>
          </div>
          {{end}} {{if .Error}}
          <div class="error-message">
            <p>{{.Error}}</p>
          </div>
          {{end}}
        </div>

        <div class="recent-urls">
          <h3>Recent URLs</h3>
          {{if .URLs}}
          <table class="url-table">
            <thead>
              <tr>
                <th>Short Link</th>
                <th>Original URL</th>
                <th>Clicks</th>
                <th>Created</th>
                <th>QR Code</th>
              </tr>
            </thead>
            <tbody>
              {{range .URLs}}
              <tr class="clickable-row" onclick="showModal('{{.ShortHash}}', '{{.FullURL}}', '{{.Clicks}}', '{{.CreatedAt.Format "Jan 02, 2006"}}', '{{$.Host}}')">
                <td>
                  <a href="/{{.ShortHash}}" target="_blank" onclick="event.stopPropagation()">/{{.ShortHash}}</a>
                </td>
                <td class="truncate">{{.FullURL}}</td>
                <td>{{.Clicks}}</td>
                <td>{{.CreatedAt.Format "Jan 02, 2006"}}</td>
                <td>
                  <img
                    src="/qr/{{.ShortHash}}"
                    alt="QR Code"
                    class="qr-code-table"
                  />
                </td>
              </tr>
              {{end}}
            </tbody>
          </table>
          {{else}}
          <p class="no-urls">No URLs shortened yet. Be the first!</p>
          {{end}}
        </div>
      </main>

      <!-- Modal -->
      <div id="urlModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>URL Details</h2>
            <span class="close">&times;</span>
          </div>
          <div class="modal-body">
            <div class="modal-info">
              <div class="info-row">
                <strong>Short URL:</strong>
                <div class="url-display">
                  <a id="modalShortUrl" href="" target="_blank" rel="noopener"></a>
                  <button
                    onclick="copyToClipboard(document.getElementById('modalShortUrl').textContent, this)"
                    class="btn-copy-modal"
                  >
                    Copy
                  </button>
                </div>
              </div>
              <div class="info-row">
                <strong>Original URL:</strong>
                <div id="urlDisplayMode">
                  <div class="original-url" id="modalOriginalUrl"></div>
                  <button onclick="enableEditMode()" class="btn-edit">Edit</button>
                </div>
                <div id="updateSuccess" class="update-success" style="display: none;">
                  <span class="success-icon">âœ“</span>
                  <span>Successfully updated!</span>
                </div>
                <div id="urlEditMode" style="display: none;">
                  <form id="updateUrlForm" onsubmit="updateUrl(event)">
                    <div class="edit-url-container">
                      <input type="hidden" id="editShortHash" name="short_hash">
                      <input type="text" id="editUrlInput" name="new_url" class="edit-url-input" placeholder="example.com" required>
                      <div class="edit-buttons">
                        <button type="submit" class="btn-save">Save</button>
                        <button type="button" onclick="cancelEdit()" class="btn-cancel">Cancel</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              <div class="info-row">
                <strong>Clicks:</strong>
                <span id="modalClicks"></span>
              </div>
              <div class="info-row">
                <strong>Created:</strong>
                <span id="modalCreated"></span>
              </div>
            </div>
            <div class="modal-qr">
              <h3>QR Code</h3>
              <img
                id="modalQrCode"
                src=""
                alt="QR Code"
                class="qr-code-modal"
              />
              <p class="qr-code-help">
                Scan with your phone to access the link
              </p>
            </div>
          </div>
        </div>
      </div>

      <script>
        function copyToClipboard(text, button) {
          navigator.clipboard
            .writeText(text)
            .then(function () {
              const originalText = button.textContent;
              button.textContent = "Copied!";
              setTimeout(() => {
                button.textContent = originalText;
              }, 3000);
            })
            .catch(function (err) {
              console.error("Failed to copy text: ", err);
              button.textContent = "Failed";
              setTimeout(() => {
                button.textContent = "Copy";
              }, 2000);
            });
        }

        // Modal functionality
        const modal = document.getElementById("urlModal");
        const closeBtn = document.getElementsByClassName("close")[0];

        let currentShortHash = "";
        let currentOriginalUrl = "";
        
        function showModal(shortHash, originalUrl, clicks, created, baseUrl) {
          const shortUrl = baseUrl + "/" + shortHash;
          
          // Store current values
          currentShortHash = shortHash;
          currentOriginalUrl = originalUrl;

          const modalShortUrlElement = document.getElementById("modalShortUrl");
          modalShortUrlElement.textContent = shortUrl;
          modalShortUrlElement.href = shortUrl;
          
          document.getElementById("modalOriginalUrl").textContent = originalUrl;
          document.getElementById("modalClicks").textContent = clicks;
          document.getElementById("modalCreated").textContent = created;
          document.getElementById("modalQrCode").src = "/qr/" + shortHash;

          // Reset to display mode
          document.getElementById("urlDisplayMode").style.display = "flex";
          document.getElementById("urlEditMode").style.display = "none";

          // Disable background scrolling
          document.body.style.overflow = "hidden";
          
          modal.style.display = "block";
        }

        function closeModal() {
          // Re-enable background scrolling
          document.body.style.overflow = "";
          modal.style.display = "none";
        }

        closeBtn.onclick = function () {
          closeModal();
        };

        window.onclick = function (event) {
          if (event.target === modal) {
            closeModal();
          }
        };

        // Close modal with Escape key
        document.addEventListener("keydown", function (event) {
          if (event.key === "Escape" && modal.style.display === "block") {
            closeModal();
          }
        });

        function closeSuccess() {
          const successCard = document.getElementById("successCard");
          if (successCard) {
            successCard.style.display = "none";
          }
        }

        function enableEditMode() {
          document.getElementById("urlDisplayMode").style.display = "none";
          document.getElementById("urlEditMode").style.display = "flex";
          document.getElementById("editShortHash").value = currentShortHash;
          document.getElementById("editUrlInput").value = currentOriginalUrl;
          document.getElementById("editUrlInput").focus();
        }

        function cancelEdit() {
          document.getElementById("urlDisplayMode").style.display = "flex";
          document.getElementById("urlEditMode").style.display = "none";
          document.getElementById("updateSuccess").style.display = "none";
        }

        function updateUrl(event) {
          event.preventDefault();
          
          const formData = new FormData(event.target);
          const saveButton = event.target.querySelector(".btn-save");
          const cancelButton = event.target.querySelector(".btn-cancel");
          const originalSaveText = saveButton.textContent;
          
          // Disable both buttons during request
          saveButton.textContent = "Saving...";
          saveButton.disabled = true;
          cancelButton.disabled = true;

          // Convert FormData to URLSearchParams for proper form encoding
          const params = new URLSearchParams();
          for (const [key, value] of formData.entries()) {
            params.append(key, value);
          }

          fetch("/update", {
            method: "POST",
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: params
          })
          .then(response => {
            if (!response.ok) {
              throw new Error("Failed to update URL");
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              // Update the display with the new URL
              const newUrl = params.get("new_url");
              currentOriginalUrl = newUrl;
              document.getElementById("modalOriginalUrl").textContent = newUrl;
              
              // Switch back to display mode immediately
              document.getElementById("urlDisplayMode").style.display = "flex";
              document.getElementById("urlEditMode").style.display = "none";
              
              // Show success message
              const successDiv = document.getElementById("updateSuccess");
              successDiv.style.display = "flex";
              
              // Hide success message after 2 seconds
              setTimeout(() => {
                successDiv.style.display = "none";
              }, 2000);
            } else {
              throw new Error("Update failed");
            }
          })
          .catch(error => {
            console.error("Error updating URL:", error);
            alert("Failed to update URL. Please try again.");
            // Re-enable buttons on error
            saveButton.textContent = originalSaveText;
            saveButton.disabled = false;
            cancelButton.disabled = false;
          });
        }
      </script>

      <footer>
        <p>&copy; 2025 QR Linker.</p>
      </footer>
    </div>
  </body>
</html>
